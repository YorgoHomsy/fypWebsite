<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <title>ECG & HRT Monitoring Dashboard</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --text-color: #333;
            --card-bg: #ffffff;
            --border-color: #ccc;
            --shadow: rgba(0,0,0,0.05);
            --primary: #007bff;
            --primary-hover: #0056b3;
            --nav-bg: white;
            --input-bg: #fff;
        }

        /* DARK MODE */
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --card-bg: #1e1e1e;
            --border-color: #444;
            --shadow: rgba(0,0,0,0.5);
            --primary: #4da3ff;
            --primary-hover: #1a73e8;
            --nav-bg: #1e1e1e;
            --input-bg: #2d2d2d;
        }

        /* RTL MODE (Arabic) */
        body.rtl {
            direction: rtl;
            text-align: right;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        /* --- HEADER GRID --- */
        .header-controls {
            display: grid; 
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-right { justify-self: end; }
        .header-left { justify-self: start; }

        .emergency-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            display: flex; align-items: center; gap: 5px;
            transition: transform 0.2s;
        }
        .emergency-btn:hover { transform: scale(1.05); background-color: #c82333; }

        .icon-btn {
            background: none; border: 1px solid var(--border-color);
            border-radius: 5px; padding: 5px 10px; cursor: pointer;
            color: var(--text-color); font-size: 1rem;
        }
        .icon-btn:hover { background: rgba(0,0,0,0.1); }

        .main-title { margin: 0; font-size: 1.5rem; text-align: center; white-space: nowrap; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: var(--card-bg); padding: 25px; border-radius: 10px;
            width: 300px; text-align: center;
            border: 1px solid var(--border-color);
        }
        .modal-title { font-size: 1.2rem; margin-bottom: 15px; font-weight: bold; }

        /* --- NAVIGATION --- */
        .nav-container {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;
            background: var(--nav-bg); padding: 15px; border-radius: 10px;
            box-shadow: 0 4px 6px var(--shadow); flex-wrap: wrap; align-items: center;
        }

        input[type="date"] {
            padding: 10px; border: 2px solid var(--primary); border-radius: 5px;
            font-family: inherit; font-weight: bold;
            color: var(--text-color); background: var(--input-bg); cursor: pointer;
        }

        .nav-btn {
            padding: 10px 20px; border: 2px solid var(--primary); background: transparent;
            color: var(--primary); cursor: pointer; border-radius: 5px; font-weight: bold;
            transition: all 0.3s ease;
        }
        .nav-btn.active { background: var(--primary); color: white; }

        .controls-container { text-align: center; margin-bottom: 20px; display: none; }
        .toggle-label { margin: 0 15px; font-weight: 600; cursor: pointer; }
        
        .charts-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 40px; }

        .chart-card {
            background: var(--card-bg); padding: 20px; border-radius: 10px;
            box-shadow: 0 4px 6px var(--shadow); width: 100%; max-width: 600px;
        }

        /* --- CONTACT SECTION --- */
        .contact-section {
            background: var(--card-bg); padding: 30px; border-radius: 10px;
            box-shadow: 0 4px 6px var(--shadow); max-width: 600px; margin: 0 auto;
        }

        .contact-header { margin-bottom: 15px; font-size: 1.2rem; font-weight: bold; text-align: center; }
        
        textarea, .input-field, .med-input, .profile-input {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color);
            border-radius: 5px; margin-bottom: 15px; box-sizing: border-box; font-family: inherit;
        }
        textarea { height: 60px; resize: none; }

        .checklist-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .checkbox-item { display: flex; align-items: center; font-size: 0.9rem; cursor: pointer; }
        
        /* RTL Fix for Checkboxes */
        body.rtl .checkbox-item input { margin-right: 0; margin-left: 8px; }
        body:not(.rtl) .checkbox-item input { margin-right: 8px; margin-left: 0; }

        .method-toggles { display: flex; gap: 15px; margin-bottom: 15px; justify-content: center; }

        .method-btn {
            padding: 8px 16px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color); cursor: pointer;
            border-radius: 5px; display: flex; align-items: center; gap: 5px;
        }
        .method-btn.selected { border-color: var(--primary); background: rgba(0, 123, 255, 0.1); color: var(--primary); font-weight: bold; }

        .input-group { margin-bottom: 10px; position: relative; }
        .input-field { display: none; }
        .input-field.visible { display: block; }

        .validation-icon {
            position: absolute; top: 50%; transform: translateY(-50%);
            color: #28a745; font-size: 1.2rem; display: none; pointer-events: none;
        }
        /* Icon Position flips in RTL */
        body:not(.rtl) .validation-icon { right: 10px; }
        body.rtl .validation-icon { left: 10px; }

        .send-btn, .save-btn {
            width: 100%; padding: 12px; background-color: var(--primary); color: white;
            border: none; border-radius: 5px; font-size: 1rem; font-weight: bold; cursor: pointer;
        }
        .send-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        @media (max-width: 480px) {
            .header-controls { grid-template-columns: 1fr; gap: 10px; justify-items: center; }
            .header-left, .header-right { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body id="dashboardBody">

    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-title" id="txt_modal_title">Patient Profile</div>
            <input type="text" id="profileName" class="profile-input" placeholder="Full Name">
            <input type="number" id="profileAge" class="profile-input" placeholder="Age">
            <button class="save-btn" onclick="saveProfile()" id="txt_modal_save">Save</button>
            <button class="method-btn" onclick="closeProfile()" style="width:100%; margin-top:10px; justify-content:center;" id="txt_modal_cancel">Close</button>
        </div>
    </div>

    <div class="header-controls">
        <div class="header-left">
            <a href="tel:140" class="emergency-btn">
                üöë <span id="txt_emergency">Emergency (140)</span>
            </a>
        </div>
        
        <h1 class="main-title" id="txt_title">Health Metrics</h1>
        
        <div class="header-right">
            <button class="icon-btn" onclick="openProfile()" title="Profile">
                üë§
            </button>
            <button class="icon-btn" onclick="toggleLang()" id="btn_lang">
                ÿπÿ±ÿ®Ÿä
            </button>
            <button class="icon-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                üåô
            </button>
        </div>
    </div>
    
    <p style="text-align:center; margin-top:0;" id="txt_subtitle">Select a date or view the monthly overview.</p>

    <div class="nav-container">
        <input type="date" id="datePicker" onchange="handleDateChange()">
        <button id="monthlyBtn" class="nav-btn" onclick="setMonthlyView()"><span id="txt_monthly">Monthly Overview</span></button>
    </div>

    <div class="controls-container" id="controlsPanel">
        <label class="toggle-label">
            <input type="checkbox" id="toggleBars" checked onchange="toggleLayers()"> <span id="txt_show_hist">Show Histograms</span>
        </label>
        <label class="toggle-label">
            <input type="checkbox" id="toggleCurves" checked onchange="toggleLayers()"> <span id="txt_show_curves">Show Curves</span>
        </label>
    </div>

    <div class="charts-container">
        <div class="chart-card">
            <h2 id="txt_chart_ecg">ECG Values (ms/mV)</h2>
            <canvas id="ecgChart"></canvas>
        </div>

        <div class="chart-card">
            <h2 id="txt_chart_hrt">HRT Values (BPM)</h2>
            <canvas id="hrtChart"></canvas>
        </div>
    </div>

    <div class="contact-section">
        <div class="contact-header" id="txt_contact_header">Doctor Communication</div>
        
        <label style="font-weight:600; font-size: 0.9rem; display:block; margin-bottom:8px;" id="txt_symptoms">Symptoms:</label>
        <div class="checklist-container">
            <label class="checkbox-item"><input type="checkbox" name="symptom" value="Dizziness"><span class="lbl-sym">Dizziness</span></label>
            <label class="checkbox-item"><input type="checkbox" name="symptom" value="Chest Pain"><span class="lbl-sym">Chest Pain</span></label>
            <label class="checkbox-item"><input type="checkbox" name="symptom" value="Shortness of Breath"><span class="lbl-sym">Shortness of Breath</span></label>
            <label class="checkbox-item"><input type="checkbox" name="symptom" value="Palpitations"><span class="lbl-sym">Palpitations</span></label>
            <label class="checkbox-item"><input type="checkbox" name="symptom" value="Fatigue"><span class="lbl-sym">Fatigue</span></label>
            <label class="checkbox-item"><input type="checkbox" name="symptom" value="Nausea"><span class="lbl-sym">Nausea</span></label>
        </div>

        <label style="font-weight:600; font-size: 0.9rem;" id="txt_meds">Medication Taken:</label>
        <input type="text" id="medInput" class="med-input" placeholder="e.g., Aspirin">

        <label style="font-weight:600; font-size: 0.9rem;" id="txt_comments">Additional Comment:</label>
        <textarea id="patientComment" placeholder="Any other notes..."></textarea>

        <div style="font-weight:600; font-size: 0.9rem; margin-bottom: 10px; text-align:center;" id="txt_method">Select Contact Method:</div>
        <div class="method-toggles">
            <button class="method-btn" onclick="selectMethod('gmail', this)">
                üìß Gmail
            </button>
            <button class="method-btn" onclick="selectMethod('whatsapp', this)">
                üì± WhatsApp
            </button>
        </div>

        <div class="input-group">
            <input type="email" id="inputEmail" class="input-field" placeholder="Doctor's Gmail" oninput="validateInput()">
            <input type="text" id="inputPhone" class="input-field" placeholder="Doctor's Mobile" oninput="validateInput()">
            <span id="checkMark" class="validation-icon">‚úì</span>
        </div>
        
        <label class="checkbox-item" style="margin-bottom:15px;">
            <input type="checkbox" id="rememberMe"> <span id="txt_remember">Remember my doctor's details</span>
        </label>

        <button id="sendBtn" class="send-btn" onclick="sendReport()" disabled><span id="txt_send">Send Report & PDF</span></button>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>

    <script>
        // --- 1. LOCALIZATION DATA ---
        const langData = {
            en: {
                emergency: "Emergency (140)", title: "Health Metrics", subtitle: "Select a date or view the monthly overview.",
                monthly: "Monthly Overview", show_hist: "Show Histograms", show_curves: "Show Curves",
                chart_ecg: "ECG Values (ms/mV)", chart_hrt: "HRT Values (BPM)",
                contact_header: "Doctor Communication", symptoms: "Symptoms:", meds: "Medication Taken:",
                comments: "Additional Comment:", method: "Select Contact Method:",
                remember: "Remember my doctor's details", send: "Send Report & PDF",
                modal_title: "Patient Profile", modal_save: "Save", modal_cancel: "Close",
                ph_name: "Full Name", ph_age: "Age", ph_med: "e.g., Aspirin", ph_notes: "Any other notes...",
                ph_email: "Doctor's Gmail", ph_phone: "Doctor's Mobile",
                sym_list: ["Dizziness", "Chest Pain", "Shortness of Breath", "Palpitations", "Fatigue", "Nausea"],
                weeks: ["Week 1", "Week 2", "Week 3", "Week 4"],
                chart_labels: ["0 Mins (Bar)", "30 Mins (Bar)", "0 Mins (Curve)", "30 Mins (Curve)"]
            },
            ar: {
                emergency: "ÿ∑Ÿàÿßÿ±ÿ¶ (140)", title: "ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿµÿ≠ÿ©", subtitle: "ÿßÿÆÿ™ÿ± ÿ™ÿßÿ±ŸäÿÆÿßŸã ÿ£Ÿà ÿßÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑÿÆÿµ ÿßŸÑÿ¥Ÿáÿ±Ÿä.",
                monthly: "ÿßŸÑŸÖŸÑÿÆÿµ ÿßŸÑÿ¥Ÿáÿ±Ÿä", show_hist: "ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ®ŸäÿßŸÜŸäÿ©", show_curves: "ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÖŸÜÿ≠ŸÜŸäÿßÿ™",
                chart_ecg: "ŸÇŸäŸÖ ÿ™ÿÆÿ∑Ÿäÿ∑ ÿßŸÑŸÇŸÑÿ® (ms/mV)", chart_hrt: "ŸÇŸäŸÖ ŸÜÿ®ÿ∂ÿßÿ™ ÿßŸÑŸÇŸÑÿ® (BPM)",
                contact_header: "ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿ∑ÿ®Ÿäÿ®", symptoms: "ÿßŸÑÿ£ÿπÿ±ÿßÿ∂:", meds: "ÿßŸÑÿ£ÿØŸàŸäÿ© ÿßŸÑŸÖÿ™ŸÜÿßŸàŸÑÿ©:",
                comments: "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©:", method: "ÿßÿÆÿ™ÿ± Ÿàÿ≥ŸäŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ:",
                remember: "ÿ™ÿ∞ŸÉÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿ∑ÿ®Ÿäÿ®Ÿä", send: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸàÿßŸÑŸÄ PDF",
                modal_title: "ŸÖŸÑŸÅ ÿßŸÑŸÖÿ±Ÿäÿ∂", modal_save: "ÿ≠ŸÅÿ∏", modal_cancel: "ÿ•ÿ∫ŸÑÿßŸÇ",
                ph_name: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ", ph_age: "ÿßŸÑÿπŸÖÿ±", ph_med: "ŸÖÿ´ŸÑÿßŸã: ÿ£ÿ≥ÿ®ÿ±ŸäŸÜ", ph_notes: "ÿ£Ÿä ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ£ÿÆÿ±Ÿâ...",
                ph_email: "ÿ®ÿ±ŸäÿØ ÿßŸÑÿ∑ÿ®Ÿäÿ® (Gmail)", ph_phone: "ÿ±ŸÇŸÖ ÿßŸÑÿ∑ÿ®Ÿäÿ®",
                sym_list: ["ÿØŸàÿÆÿ©", "ÿ£ŸÑŸÖ ŸÅŸä ÿßŸÑÿµÿØÿ±", "ÿ∂ŸäŸÇ ŸÅŸä ÿßŸÑÿ™ŸÜŸÅÿ≥", "ÿÆŸÅŸÇÿßŸÜ ÿßŸÑŸÇŸÑÿ®", "ÿ™ÿπÿ®", "ÿ∫ÿ´ŸäÿßŸÜ"],
                weeks: ["ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ 1", "ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ 2", "ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ 3", "ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ 4"],
                chart_labels: ["0 ÿØŸÇŸäŸÇÿ© (ÿπÿßŸÖŸàÿØ)", "30 ÿØŸÇŸäŸÇÿ© (ÿπÿßŸÖŸàÿØ)", "0 ÿØŸÇŸäŸÇÿ© (ŸÖŸÜÿ≠ŸÜŸâ)", "30 ÿØŸÇŸäŸÇÿ© (ŸÖŸÜÿ≠ŸÜŸâ)"]
            }
        };

        // --- 2. STATE ---
        let currentLang = 'en';
        let currentViewMode = 'daily'; 
        let currentViewLabel = ""; 
        let isDarkMode = false;
        let currentMethod = null;

        // --- 3. PROFILE MODAL LOGIC ---
        function openProfile() { document.getElementById('profileModal').style.display = 'flex'; }
        function closeProfile() { document.getElementById('profileModal').style.display = 'none'; }
        
        function saveProfile() {
            const name = document.getElementById('profileName').value;
            const age = document.getElementById('profileAge').value;
            localStorage.setItem('patientName', name);
            localStorage.setItem('patientAge', age);
            closeProfile();
            alert(currentLang === 'en' ? "Profile Saved" : "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ");
        }

        function loadProfile() {
            const name = localStorage.getItem('patientName');
            const age = localStorage.getItem('patientAge');
            if(name) document.getElementById('profileName').value = name;
            if(age) document.getElementById('profileAge').value = age;
        }

        // --- 4. LANGUAGE LOGIC ---
        function toggleLang() {
            currentLang = (currentLang === 'en') ? 'ar' : 'en';
            
            // Toggle RTL Class
            if(currentLang === 'ar') document.body.classList.add('rtl');
            else document.body.classList.remove('rtl');

            // Update Toggle Button Text
            document.getElementById('btn_lang').innerText = (currentLang === 'en') ? 'ÿπÿ±ÿ®Ÿä' : 'English';

            // Apply Translations
            const data = langData[currentLang];
            
            // Text Content
            const mapping = {
                'txt_emergency': data.emergency, 'txt_title': data.title, 'txt_subtitle': data.subtitle,
                'txt_monthly': data.monthly, 'txt_show_hist': data.show_hist, 'txt_show_curves': data.show_curves,
                'txt_chart_ecg': data.chart_ecg, 'txt_chart_hrt': data.chart_hrt, 'txt_contact_header': data.contact_header,
                'txt_symptoms': data.symptoms, 'txt_meds': data.meds, 'txt_comments': data.comments,
                'txt_method': data.method, 'txt_remember': data.remember, 'txt_send': data.send,
                'txt_modal_title': data.modal_title, 'txt_modal_save': data.modal_save, 'txt_modal_cancel': data.modal_cancel
            };
            for (const [id, text] of Object.entries(mapping)) {
                if(document.getElementById(id)) document.getElementById(id).innerText = text;
            }

            // Placeholders
            document.getElementById('profileName').placeholder = data.ph_name;
            document.getElementById('profileAge').placeholder = data.ph_age;
            document.getElementById('medInput').placeholder = data.ph_med;
            document.getElementById('patientComment').placeholder = data.ph_notes;
            document.getElementById('inputEmail').placeholder = data.ph_email;
            document.getElementById('inputPhone').placeholder = data.ph_phone;

            // Checkbox Labels
            const symLabels = document.querySelectorAll('.lbl-sym');
            symLabels.forEach((lbl, index) => { lbl.innerText = data.sym_list[index]; });

            // Refresh Charts to update Labels/Weeks
            if(currentViewMode === 'monthly') setMonthlyView();
            else handleDateChange();
        }

        // --- 5. THEME LOGIC ---
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            document.querySelector('.theme-toggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            updateChartTheme(ecgChartInstance);
            updateChartTheme(hrtChartInstance);
        }

        function updateChartTheme(chart) {
            const gridColor = isDarkMode ? '#444' : '#ddd';
            const tickColor = isDarkMode ? '#e0e0e0' : '#333';
            chart.options.scales.x.grid.color = gridColor;
            chart.options.scales.y.grid.color = gridColor;
            chart.options.scales.x.ticks.color = tickColor;
            chart.options.scales.y.ticks.color = tickColor;
            chart.update();
        }

        // --- 6. DATA & CHARTS ---
        function getPseudoRandomData(seedString) {
            let hash = 0;
            for (let i = 0; i < seedString.length; i++) hash = ((hash << 5) - hash) + seedString.charCodeAt(i) | 0;
            const absHash = Math.abs(hash);
            return { ecg: [ 70 + (absHash % 20), 65 + (absHash % 15) ], hrt: [ 60 + (absHash % 30), 60 + ((absHash * 2) % 25) ] };
        }

        function handleDateChange() {
            const datePicker = document.getElementById('datePicker');
            if(!datePicker.value) return;
            
            currentViewMode = 'daily';
            currentViewLabel = datePicker.value;
            
            document.getElementById('monthlyBtn').classList.remove('active');
            datePicker.style.borderColor = "var(--primary)";
            document.getElementById('controlsPanel').style.display = 'none';

            const data = getPseudoRandomData(datePicker.value);
            updateSingleChart(ecgChartInstance, [currentViewLabel], [data.ecg[0]], [data.ecg[1]], [], []);
            updateSingleChart(hrtChartInstance, [currentViewLabel], [data.hrt[0]], [data.hrt[1]], [], []);
        }

        function setMonthlyView() {
            currentViewMode = 'monthly';
            currentViewLabel = langData[currentLang].monthly;
            
            document.getElementById('monthlyBtn').classList.add('active');
            document.getElementById('datePicker').value = "";
            document.getElementById('datePicker').style.borderColor = "#ccc";
            document.getElementById('controlsPanel').style.display = 'block';

            // Use Localized Labels for Weeks
            const labels = langData[currentLang].weeks;
            let ecg0=[], ecg30=[], hrt0=[], hrt30=[];

            for (let w = 0; w < 4; w++) {
                let sE0=0, sE30=0, sH0=0, sH30=0;
                for (let d = 0; d < 7; d++) {
                    let daily = getPseudoRandomData(`2023-10-${(w * 7) + d + 1}`);
                    sE0+=daily.ecg[0]; sE30+=daily.ecg[1]; sH0+=daily.hrt[0]; sH30+=daily.hrt[1];
                }
                ecg0.push(Math.round(sE0/7)); ecg30.push(Math.round(sE30/7));
                hrt0.push(Math.round(sH0/7)); hrt30.push(Math.round(sH30/7));
            }
            updateSingleChart(ecgChartInstance, labels, ecg0, ecg30, ecg0, ecg30);
            updateSingleChart(hrtChartInstance, labels, hrt0, hrt30, hrt0, hrt30);
        }

        let ecgChartInstance = null, hrtChartInstance = null;

        function createChart(canvasId, colorB, colorA, colorLB, colorLA) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                plugins: [{
                    id: 'align', beforeDatasetsDraw(c) {
                        const pairs=[[0,2],[1,3]];
                        pairs.forEach(([bI,lI])=>{
                            const bM=c.getDatasetMeta(bI), lM=c.getDatasetMeta(lI);
                            if(!bM.hidden && !lM.hidden && bM.data.length===lM.data.length)
                                lM.data.forEach((p,i)=>{ if(bM.data[i]) p.x=bM.data[i].x; });
                        });
                    }
                }],
                data: {
                    labels: [],
                    datasets: [
                        { type: 'bar', data: [], backgroundColor: colorB, borderRadius:5, order:3, barPercentage:0.6 },
                        { type: 'bar', data: [], backgroundColor: colorA, borderRadius:5, order:3, barPercentage:0.6 },
                        { type: 'line', data: [], borderColor: colorLB, backgroundColor:colorLB, borderWidth:2, pointRadius:4, order:1 },
                        { type: 'line', data: [], borderColor: colorLA, backgroundColor:colorLA, borderWidth:2, pointRadius:4, order:1 }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero:true }, x: { offset:true } },
                    plugins: { legend: { position: 'bottom', labels: { filter: (l, d) => d.datasets[l.datasetIndex].type!=='line'||d.datasets[l.datasetIndex].data.length>0 } } }
                }
            });
        }

        ecgChartInstance = createChart('ecgChart', 'rgba(255, 99, 132, 0.6)', 'rgba(255, 99, 132, 1)', 'rgba(255, 99, 132, 1)', 'rgba(153, 0, 51, 1)');
        hrtChartInstance = createChart('hrtChart', 'rgba(54, 162, 235, 0.6)', 'rgba(54, 162, 235, 1)', 'rgba(54, 162, 235, 1)', 'rgba(0, 51, 102, 1)');

        function updateSingleChart(chart, labels, b0, b30, l0, l30) {
            chart.data.labels = labels;
            // Update Legend Labels based on Language
            const leg = langData[currentLang].chart_labels;
            chart.data.datasets[0].label = leg[0];
            chart.data.datasets[1].label = leg[1];
            chart.data.datasets[2].label = leg[2];
            chart.data.datasets[3].label = leg[3];

            chart.data.datasets[0].data = b0; chart.data.datasets[1].data = b30;
            chart.data.datasets[2].data = l0; chart.data.datasets[3].data = l30;
            
            if(l0.length===0) {
                chart.getDatasetMeta(0).hidden=false; chart.getDatasetMeta(1).hidden=false;
                chart.getDatasetMeta(2).hidden=true; chart.getDatasetMeta(3).hidden=true;
            } else toggleLayers();
            chart.update();
        }

        function toggleLayers() {
            if(currentViewMode!=='monthly') return;
            const bars = document.getElementById('toggleBars').checked;
            const curves = document.getElementById('toggleCurves').checked;
            [ecgChartInstance, hrtChartInstance].forEach(c => {
                c.getDatasetMeta(0).hidden = !bars; c.getDatasetMeta(1).hidden = !bars;
                c.getDatasetMeta(2).hidden = !curves; c.getDatasetMeta(3).hidden = !curves;
                c.update();
            });
        }

        // --- 7. CONTACT & SEND ---
        function selectMethod(m, btn) {
            currentMethod = m;
            document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            const em = document.getElementById('inputEmail'), ph = document.getElementById('inputPhone');
            if(m==='gmail') { em.classList.add('visible'); ph.classList.remove('visible'); if(!em.value) em.focus(); }
            else { em.classList.remove('visible'); ph.classList.add('visible'); if(!ph.value) ph.focus(); }
            validateInput();
        }

        function validateInput() {
            const check = document.getElementById('checkMark'), btn = document.getElementById('sendBtn');
            let valid = false;
            if(currentMethod==='gmail') valid = /^[a-zA-Z0-9._%+-]+@gmail\.com$/.test(document.getElementById('inputEmail').value.trim());
            else if(currentMethod==='whatsapp') valid = /^(?:\+?961|0)?(3|70|71|76|78|79|81)\d{6}$/.test(document.getElementById('inputPhone').value.replace(/\s+/g,''));
            
            check.style.display = valid ? 'block' : 'none';
            btn.disabled = !valid;
        }

        function sendReport() {
            // OFFLINE CHECK
            if(!navigator.onLine) {
                const msg = currentLang==='en' 
                    ? "You are currently offline. The PDF will be generated, but you cannot send the message until internet returns." 
                    : "ÿ£ŸÜÿ™ ÿ≠ÿßŸÑŸäÿßŸã ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™. ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ PDFÿå ŸÑŸÉŸÜ ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ≠ÿ™Ÿâ ÿπŸàÿØÿ© ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.";
                alert(msg);
            }

            // Data Gathering
            const pName = localStorage.getItem('patientName') || "Unknown";
            const pAge = localStorage.getItem('patientAge') || "?";
            const comment = document.getElementById('patientComment').value;
            const med = document.getElementById('medInput').value || (currentLang==='en'?"None":"ŸÑÿß ŸäŸàÿ¨ÿØ");
            
            let syms = [];
            document.querySelectorAll('input[name="symptom"]:checked').forEach(cb => {
                syms.push(cb.parentElement.querySelector('span').innerText);
            });
            const symStr = syms.length ? syms.join(', ') : (currentLang==='en'?"None":"ŸÑÿß ŸäŸàÿ¨ÿØ");
            
            // Save Doctor if needed
            if(document.getElementById('rememberMe').checked) {
                localStorage.setItem('docEmail', document.getElementById('inputEmail').value);
                localStorage.setItem('docPhone', document.getElementById('inputPhone').value);
            }

            // PDF Generation
            const dateStr = new Date().toISOString().slice(0,10);
            const pdfName = `Health_Report_${pName}_${dateStr}.pdf`;
            
            const reportTitle = currentLang==='en' 
                ? `Health Report for ${pName} (Age: ${pAge})`
                : `ÿ™ŸÇÿ±Ÿäÿ± ÿµÿ≠Ÿä ŸÑŸÑŸÖÿ±Ÿäÿ∂: ${pName} (ÿßŸÑÿπŸÖÿ±: ${pAge})`;

            const oldTitle = document.getElementById('txt_title').innerText;
            document.getElementById('txt_title').innerText = reportTitle;

            const wasDark = document.body.classList.contains('dark-mode');
            if(wasDark) toggleTheme();

            const element = document.body;
            html2pdf().set({ margin: [10,0], filename: pdfName, html2canvas:{scale:2}, jsPDF:{unit:'mm', format:'a4'} }).from(element).save().then(() => {
                document.getElementById('txt_title').innerText = oldTitle;
                if(wasDark) toggleTheme();

                // Send Msg (Only if online, but we open the intent anyway)
                let url="";
                const body = currentLang==='en'
                    ? `Patient: ${pName} (Age: ${pAge})\nView: ${currentViewLabel}\nSymptoms: ${symStr}\nMeds: ${med}\nNote: ${comment}\n(PDF Attached)`
                    : `ÿßŸÑŸÖÿ±Ÿäÿ∂: ${pName} (ÿßŸÑÿπŸÖÿ±: ${pAge})\nÿπÿ±ÿ∂: ${currentViewLabel}\nÿßŸÑÿ£ÿπÿ±ÿßÿ∂: ${symStr}\nÿ£ÿØŸàŸäÿ©: ${med}\nŸÖŸÑÿßÿ≠ÿ∏ÿ©: ${comment}\n(ŸÖÿ±ŸÅŸÇ PDF)`;

                const subject = currentLang==='en' ? `Health Report - ${pName}` : `ÿ™ŸÇÿ±Ÿäÿ± ÿµÿ≠Ÿä - ${pName}`;

                if(currentMethod==='gmail') {
                    url = `mailto:${document.getElementById('inputEmail').value}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                } else {
                    let ph = document.getElementById('inputPhone').value.replace(/\D/g,'');
                    if(ph.startsWith('0')) ph='961'+ph.substring(1); else if(!ph.startsWith('961')) ph='961'+ph;
                    url = `https://wa.me/${ph}?text=${encodeURIComponent(body)}`;
                }
                window.open(url, '_blank');
            });
        }

        // Init
        window.onload = function() {
            document.getElementById('datePicker').value = new Date().toISOString().split('T')[0];
            handleDateChange();
            loadProfile();
            const sE=localStorage.getItem('docEmail'), sP=localStorage.getItem('docPhone');
            if(sE) document.getElementById('inputEmail').value=sE;
            if(sP) document.getElementById('inputPhone').value=sP;
        };
    </script>
</body>
</html>
